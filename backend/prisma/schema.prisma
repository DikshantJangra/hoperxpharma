generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}

model User {
  id                            String                   @id @default(cuid())
  email                         String                   @unique
  phoneNumber                   String                   @unique
  passwordHash                  String
  firstName                     String
  lastName                      String
  role                          UserRole                 @default(PHARMACIST)
  approvalPin                   String?
  isActive                      Boolean                  @default(true)
  pinHash                       String?
  pinAttempts                   Int                      @default(0)
  pinLockedUntil                DateTime?
  lastLoginAt                   DateTime?
  faceDataUrl                   String?
  hourlyRate                    Decimal?                 @db.Decimal(10, 2)
  monthlyRate                   Decimal?                 @db.Decimal(10, 2)
  shiftId                       String?
  joiningDate                   DateTime?
  emergencyContactName          String?
  emergencyContactPhone         String?
  employeeId                    String?                  @unique
  createdAt                     DateTime                 @default(now())
  updatedAt                     DateTime                 @updatedAt
  deletedAt                     DateTime?
  signatureUrl                  String?
  preferences                   Json?
  storeUsers                    StoreUser[]
  auditLogs                     AuditLog[]
  accessLogs                    AccessLog[]
  onboarding                    OnboardingProgress?
  returnsRequested              SupplierReturn[]         @relation("ReturnRequester")
  returnsApproved               SupplierReturn[]         @relation("ReturnApprover")
  userRoles                     UserRoleAssignment[]
  adminPin                      AdminPin?
  grns                          GoodsReceivedNote[]
  savedFilters                  SavedFilter[]
  avatars                       UserAvatar[]
  alertPreferences              AlertPreference[]
  attendanceLogs                AttendanceLog[]
  documents                     StaffDocument[]
  performanceMetrics            PerformanceMetric[]
  shift                         Shift?                   @relation(fields: [shiftId], references: [id])
  consolidatedInvoicesCreated   ConsolidatedInvoice[]    @relation("ConsolidatedInvoiceCreator")
  consolidatedInvoicesConfirmed ConsolidatedInvoice[]    @relation("ConsolidatedInvoiceConfirmer")
  supplierInvoicePayments       SupplierInvoicePayment[]
  saltsCreated                  Salt[]                   @relation("SaltCreator")

  @@index([email])
  @@index([phoneNumber])
  @@index([deletedAt])
}

model OnboardingProgress {
  id             String   @id @default(cuid())
  userId         String   @unique
  currentStep    Int      @default(1)
  completedSteps Int[]
  data           Json
  isComplete     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  mode           String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MagicLink {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  userId    String?
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

model Role {
  id          String               @id @default(cuid())
  name        String               @unique
  description String?
  builtIn     Boolean              @default(false)
  category    String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  storeId     String?
  permissions RolePermission[]
  userRoles   UserRoleAssignment[]
  store       Store?               @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([builtIn])
  @@index([category])
  @@index([storeId])
}

model Permission {
  id          String           @id @default(cuid())
  code        String           @unique
  name        String
  description String?
  category    String
  resource    String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@index([category])
  @@index([resource])
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model StoreUser {
  userId     String
  storeId    String
  isPrimary  Boolean  @default(false)
  assignedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@id([userId, storeId])
  @@index([storeId])
}

model UserRoleAssignment {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  storeId    String?
  assignedAt DateTime @default(now())
  assignedBy String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  store      Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, storeId])
  @@index([userId])
  @@index([roleId])
  @@index([storeId])
}

model AdminPin {
  id             String    @id @default(cuid())
  userId         String    @unique
  pinHash        String
  salt           String
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastUsedAt     DateTime?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BusinessTypeConfig {
  id                 String   @id @default(cuid())
  businessType       String   @unique
  featureConfig      Json
  enabledSections    String[]
  defaultPermissions String[]
  description        String?
  icon               String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([businessType])
}

model Store {
  id                  String                @id @default(cuid())
  name                String
  displayName         String
  email               String                @unique
  phoneNumber         String
  businessType        String?
  logoUrl             String?
  addressLine1        String
  addressLine2        String?
  city                String
  state               String
  pinCode             String
  landmark            String?
  is24x7              Boolean               @default(false)
  homeDelivery        Boolean               @default(false)
  latitude            Float?
  longitude           Float?
  geofenceRadius      Int?                  @default(50)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deletedAt           DateTime?
  dlNumber            String?
  gstin               String?
  whatsapp            String?
  pan                 String?
  featureOverrides    Json?
  bankDetails         Json?
  jurisdiction        String?
  signatureUrl        String?
  termsAndConditions  String?
  whatsappMode        String?
  isDemo              Boolean               @default(false)
  users               StoreUser[]
  licenses            StoreLicense[]
  operatingHours      StoreOperatingHours[]
  devices             HardwareDevice[]
  subscription        Subscription?
  userRoles           UserRoleAssignment[]
  roles               Role[]
  patients            Patient[]
  prescribers         Prescriber[]
  prescriptions       Prescription[]
  inventory           InventoryBatch[]
  suppliers           Supplier[]
  drugs               Drug[]
  sales               Sale[]
  saleDrafts          SaleDraft[]
  saleRefunds         SaleRefund[]
  purchaseOrders      PurchaseOrder[]
  expenses            Expense[]
  campaigns           Campaign[]
  auditLogs           AuditLog[]
  alerts              Alert[]
  alertPreferences    AlertPreference[]
  returns             SupplierReturn[]
  whatsappAccount     WhatsAppAccount?
  attendanceLogs      AttendanceLog[]
  shifts              Shift[]
  performanceMetrics  PerformanceMetric[]
  settings            StoreSettings?
  ConsolidatedInvoice ConsolidatedInvoice[]
  ledger              CustomerLedger[]
  emailAccounts       EmailAccount[]
  payments            Payment[]
  marginLedger        MarginLedger[]

  @@index([email])
  @@index([deletedAt])
}

model StoreLicense {
  id          String   @id @default(cuid())
  storeId     String
  type        String
  number      String
  validFrom   DateTime
  validTo     DateTime
  documentUrl String?
  status      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, type])
  @@index([validTo])
}

model StoreOperatingHours {
  id         String  @id @default(cuid())
  storeId    String
  dayOfWeek  Int
  openTime   String
  closeTime  String
  isClosed   Boolean @default(false)
  lunchStart String?
  lunchEnd   String?
  store      Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, dayOfWeek])
}

model StoreSettings {
  id                  String   @id @default(cuid())
  storeId             String   @unique
  lowStockThreshold   Int      @default(10)
  nearExpiryThreshold Int      @default(90)
  defaultUoM          String   @default("Units")
  defaultGSTSlab      String   @default("12")
  batchTracking       Boolean  @default(true)
  autoGenerateCodes   Boolean  @default(true)
  purchaseRounding    Boolean  @default(true)
  allowNegativeStock  Boolean  @default(false)
  invoiceFormat       String   @default("INV-{YY}{MM}-{SEQ:4}")
  paymentMethods      String   @default("Cash")
  billingType         String   @default("MRP-based")
  printFormat         String   @default("Thermal")
  footerText          String   @default("Thank you for your business!")
  autoRounding        Boolean  @default(true)
  defaultCustomerType String   @default("Walk-in")
  enableGSTBilling    Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  workbenchMode       String   @default("SIMPLE")
  upiId               String?
  store               Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
}

model HardwareDevice {
  id              String    @id @default(cuid())
  storeId         String
  name            String
  type            String
  serialNumber    String?
  ipAddress       String?
  macAddress      String?
  status          String
  lastPingAt      DateTime?
  firmwareVersion String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  store           Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
}

model SubscriptionPlan {
  id                String         @id @default(cuid())
  name              String         @unique
  displayName       String
  description       String?
  price             Decimal        @db.Decimal(10, 2)
  currency          String         @default("INR")
  billingCycle      String
  patientLimit      Int?
  prescriptionLimit Int?
  storageLimit      Int?
  multiStore        Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subscriptions     Subscription[]
}

model Subscription {
  id                 String             @id @default(cuid())
  storeId            String             @unique
  planId             String?
  status             SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  autoRenew          Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  activeVerticals    String[]           @default([])
  billingCycle       String             @default("monthly")
  comboBundle        String?
  monthlyAmount      Decimal?           @db.Decimal(10, 2)
  welcomeShown       Boolean            @default(false)
  welcomeShownAt     DateTime?
  store              Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  plan               SubscriptionPlan?  @relation(fields: [planId], references: [id])
  usageQuota         UsageQuota?
  payments           Payment[]

  @@index([status])
  @@index([currentPeriodEnd])
}

model UsageQuota {
  id                    String       @id @default(cuid())
  subscriptionId        String       @unique
  patientCountUsed      Int          @default(0)
  prescriptionCountUsed Int          @default(0)
  storageMbUsed         Int          @default(0)
  resetsAt              DateTime
  updatedAt             DateTime     @updatedAt
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
}

model Payment {
  id                String         @id @default(cuid())
  storeId           String
  subscriptionId    String?
  amount            Decimal        @db.Decimal(10, 2)
  currency          String         @default("INR")
  status            String
  method            String?
  razorpayOrderId   String         @unique
  razorpayPaymentId String?        @unique
  razorpaySignature String?
  metadata          Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  amountPaise       Int
  userId            String?
  idempotencyKey    String?
  completedAt       DateTime?
  store             Store          @relation(fields: [storeId], references: [id])
  subscription      Subscription?  @relation(fields: [subscriptionId], references: [id])
  events            PaymentEvent[]

  @@index([storeId])
  @@index([razorpayOrderId])
}

model PaymentEvent {
  id          String   @id @default(cuid())
  paymentId   String
  eventType   String
  eventSource String
  oldStatus   String?
  newStatus   String
  rawPayload  Json?
  createdAt   DateTime @default(now())
  createdBy   String
  payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([paymentId, createdAt])
  @@index([paymentId])
  @@index([eventType])
}

model WebhookEvent {
  id              String    @id @default(cuid())
  razorpayEventId String    @unique
  eventType       String
  signature       String
  rawPayload      Json
  processed       Boolean   @default(false)
  processingError String?
  receivedAt      DateTime  @default(now())
  processedAt     DateTime?

  @@index([eventType, processed])
}

model PaymentReconciliation {
  id             String   @id @default(cuid())
  paymentId      String
  attemptNumber  Int
  status         String
  razorpayStatus String?
  apiResponse    Json?
  resolution     String?
  notes          String?
  attemptedAt    DateTime @default(now())

  @@index([paymentId])
}

model IdempotencyCache {
  id           String   @id @default(cuid())
  key          String   @unique
  statusCode   Int
  responseBody Json
  createdAt    DateTime @default(now())
  expiresAt    DateTime
}

model Patient {
  id                    String             @id @default(cuid())
  storeId               String
  firstName             String
  middleName            String?
  lastName              String
  dateOfBirth           DateTime?
  gender                String?
  photoUrl              String?
  phoneNumber           String
  email                 String?
  addressLine1          String?
  addressLine2          String?
  city                  String?
  state                 String?
  pinCode               String?
  bloodGroup            String?
  allergies             String[]
  chronicConditions     String[]
  emergencyContactName  String?
  emergencyContactPhone String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?
  deletedBy             String?
  creditLimit           Decimal            @default(0.00) @db.Decimal(10, 2)
  currentBalance        Decimal            @default(0.00) @db.Decimal(10, 2)
  relatedTo             PatientRelation[]  @relation("SourcePatient")
  relatedFrom           PatientRelation[]  @relation("RelatedPatient")
  store                 Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  prescriptions         Prescription[]
  sales                 Sale[]
  dispensedSales        Sale[]             @relation("DispenseFor")
  consents              PatientConsent[]
  insurance             PatientInsurance[]
  adherence             PatientAdherence[]
  auditLogs             PatientAudit[]
  ledger                CustomerLedger[]
  loyaltyProfile        LoyaltyProfile?

  @@index([storeId, phoneNumber])
  @@index([storeId, email])
  @@index([storeId, lastName, firstName])
  @@index([storeId, deletedAt])
}

model SavedFilter {
  id           String   @id @default(cuid())
  name         String
  userId       String
  filters      Json
  type         String   @default("filter")
  alertEnabled Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model PatientConsent {
  id                  String    @id @default(cuid())
  patientId           String
  type                String
  status              String
  grantedDate         DateTime  @default(now())
  expiryDate          DateTime?
  digitalSignatureUrl String?
  patient             Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, type])
}

model PatientInsurance {
  id           String   @id @default(cuid())
  patientId    String
  provider     String
  policyNumber String
  groupNumber  String?
  validUntil   DateTime
  status       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  patient      Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

model PatientAdherence {
  id                 String    @id @default(cuid())
  patientId          String
  prescriptionId     String
  expectedRefillDate DateTime
  actualRefillDate   DateTime?
  adherenceRate      Float
  createdAt          DateTime  @default(now())
  patient            Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([expectedRefillDate])
}

model InteractionCheckLog {
  id              String   @id @default(cuid())
  storeId         String
  prescriptionId  String?
  checkedBy       String
  drugIds         String[]
  hasInteractions Boolean
  severity        String?
  apiResponse     Json?
  createdAt       DateTime @default(now())

  @@index([storeId, prescriptionId])
}

model CustomerLedger {
  id            String              @id @default(cuid())
  storeId       String
  patientId     String
  type          LedgerType
  amount        Decimal             @db.Decimal(10, 2)
  balanceAfter  Decimal             @db.Decimal(10, 2)
  referenceType LedgerReferenceType
  referenceId   String?
  notes         String?
  createdBy     String?
  createdAt     DateTime            @default(now())
  patient       Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  store         Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  allocations   InvoiceAllocation[]

  @@index([patientId])
  @@index([storeId])
  @@index([createdAt])
}

model Drug {
  id                       String                    @id @default(cuid())
  rxcui                    String?
  name                     String
  genericName              String?
  strength                 String?
  form                     String?
  manufacturer             String?
  schedule                 String?
  hsnCode                  String?
  gstRate                  Decimal                   @default(0) @db.Decimal(5, 2)
  requiresPrescription     Boolean                   @default(false)
  defaultUnit              String?
  lowStockThreshold        Int?
  description              String?
  lastSyncedAt             DateTime?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  storeId                  String
  hsnCodeId                String?
  baseUnit                 String?
  displayUnit              String?
  lowStockThresholdBase    Decimal?                  @db.Decimal(12, 3)
  hsnCodeRef               HsnCode?                  @relation(fields: [hsnCodeId], references: [id])
  store                    Store                     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  inventory                InventoryBatch[]
  prescriptionItems        PrescriptionItem[]
  poItems                  PurchaseOrderItem[]
  saleItems                SaleItem[]
  returnItems              SupplierReturnItem[]
  grnItems                 GRNItem[]
  prescriptionItemVersions PrescriptionItemVersion[]
  unitConfigurations       DrugUnit[]
  locationMappings         LocationMapping[]
  saltLinks                DrugSaltLink[]
  ingestionStatus          DrugIngestionStatus       @default(ACTIVE)
  stripImageUrl            String?
  ocrMetadata              Json?
  marginLedger             MarginLedger[]

  @@index([name])
  @@index([hsnCode])
  @@index([hsnCodeId])
  @@index([storeId])
  @@index([storeId, name])
  @@index([storeId, hsnCode])
  @@index([storeId, baseUnit])
}

model TaxSlab {
  id        String    @id @default(cuid())
  storeId   String?
  name      String
  rate      Decimal   @db.Decimal(5, 2)
  taxType   String
  isActive  Boolean   @default(true)
  isSplit   Boolean   @default(true)
  cgstRate  Decimal?  @db.Decimal(5, 2)
  sgstRate  Decimal?  @db.Decimal(5, 2)
  igstRate  Decimal?  @db.Decimal(5, 2)
  cessRate  Decimal?  @db.Decimal(5, 2)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  hsnCodes  HsnCode[]

  @@unique([storeId, name])
  @@index([storeId, isActive])
}

model HsnCode {
  id          String   @id @default(cuid())
  storeId     String?
  code        String
  description String
  taxSlabId   String
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  taxSlab     TaxSlab  @relation(fields: [taxSlabId], references: [id])
  drugs       Drug[]

  @@unique([storeId, code])
  @@index([code])
  @@index([category])
}

model TaxRate {
  id          String   @id @default(cuid())
  hsnCode     String   @unique
  gstRate     Decimal  @db.Decimal(5, 2)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InventoryBatch {
  id                       String                    @id @default(cuid())
  storeId                  String
  drugId                   String
  batchNumber              String
  expiryDate               DateTime
  quantityInStock          Int
  mrp                      Decimal                   @db.Decimal(10, 2)
  purchasePrice            Decimal                   @db.Decimal(10, 2)
  supplierId               String?
  location                 String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  deletedAt                DateTime?
  barcodeType              String?
  baseUnitQuantity         Decimal?                  @db.Decimal(12, 3)
  baseUnitReserved         Decimal                   @default(0) @db.Decimal(12, 3)
  internalQRCode           String?                   @unique
  looseTabletsCount        Int                       @default(0)
  manufacturerBarcode      String?
  partialStripsCount       Int                       @default(0)
  receivedQuantity         Int?
  receivedUnit             String?
  tabletsPerStrip          Int?
  store                    Store                     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  drug                     Drug                      @relation(fields: [drugId], references: [id])
  movements                StockMovement[]
  dispenseItems            DispenseItem[]
  saleItems                SaleItem[]
  PrescriptionItem         PrescriptionItem[]
  prescriptionItemVersions PrescriptionItemVersion[]
  barcodes                 BarcodeRegistry[]
  partialStrips            PartialStripInventory[]
  marginLedger             MarginLedger[]

  @@unique([storeId, batchNumber, drugId])
  @@index([storeId, drugId])
  @@index([storeId, expiryDate, quantityInStock])
  @@index([drugId, expiryDate])
  @@index([supplierId, createdAt])
  @@index([batchNumber])
  @@index([storeId, deletedAt])
  @@index([storeId, drugId, baseUnitQuantity])
}

model StockMovement {
  id               String         @id @default(cuid())
  batchId          String
  movementType     String
  quantity         Int
  reason           String?
  referenceType    String?
  referenceId      String?
  userId           String?
  createdAt        DateTime       @default(now())
  baseUnitQuantity Decimal?       @db.Decimal(12, 3)
  movementUnit     String?
  originalQuantity Int?
  batch            InventoryBatch @relation(fields: [batchId], references: [id])

  @@index([batchId, createdAt])
  @@index([referenceType, referenceId])
  @@index([userId, createdAt])
}

model StockAdjustment {
  id               String   @id @default(cuid())
  storeId          String
  batchId          String
  quantityAdjusted Int
  reason           String
  userId           String
  createdAt        DateTime @default(now())

  @@index([storeId, createdAt])
}

model StockAlert {
  id           String    @id @default(cuid())
  storeId      String
  drugId       String
  alertType    String
  threshold    Int?
  currentValue Int?
  status       String
  createdAt    DateTime  @default(now())
  resolvedAt   DateTime?

  @@index([storeId, status])
}

model InventoryCount {
  id            String    @id @default(cuid())
  storeId       String
  countDate     DateTime
  countedBy     String
  status        String
  notes         String?
  discrepancies Json?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  @@index([storeId, countDate])
}

model InventoryForecast {
  id              String   @id @default(cuid())
  storeId         String
  drugId          String
  forecastDate    DateTime
  predictedDemand Int
  confidence      Float
  algorithm       String
  createdAt       DateTime @default(now())

  @@unique([storeId, drugId, forecastDate])
  @@index([storeId, forecastDate])
}

model Prescription {
  id                 String                @id @default(cuid())
  storeId            String
  patientId          String
  prescriberId       String?
  source             String                @default("manual")
  priority           String                @default("Normal")
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  deletedAt          DateTime?
  notes              String?
  controlledFlag     Boolean               @default(false)
  eRxId              String?
  eRxMetadata        Json?
  nextRefillDue      DateTime?
  ocrConfidence      Float?
  ocrText            String?
  reminderSent       DateTime?
  uploadedImages     String[]
  prescriptionNumber String
  type               PrescriptionType      @default(REGULAR)
  issueDate          DateTime              @default(now())
  expiryDate         DateTime
  totalRefills       Int                   @default(0)
  status             PrescriptionStatus    @default(DRAFT)
  store              Store                 @relation(fields: [storeId], references: [id])
  patient            Patient               @relation(fields: [patientId], references: [id])
  prescriber         Prescriber?           @relation(fields: [prescriberId], references: [id])
  versions           PrescriptionVersion[]
  refills            Refill[]
  files              PrescriptionFile[]
  sales              Sale[]
  prescriptionItems  PrescriptionItem[]
  dispenseEvents     DispenseEvent[]

  @@unique([storeId, prescriptionNumber])
  @@index([storeId, status, expiryDate])
  @@index([patientId, status, createdAt])
  @@index([prescriberId, createdAt])
  @@index([storeId])
  @@index([patientId])
  @@index([prescriberId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([deletedAt])
}

model PrescriptionItem {
  id                 String          @id @default(cuid())
  prescriptionId     String
  drugId             String
  quantityPrescribed Int
  unit               String?
  conversionFactor   Decimal?        @db.Decimal(10, 2)
  sig                String?
  daysSupply         Int?
  isControlled       Boolean         @default(false)
  batchId            String?
  prescription       Prescription    @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  drug               Drug            @relation(fields: [drugId], references: [id])
  batch              InventoryBatch? @relation(fields: [batchId], references: [id])
  refillItems        RefillItem[]

  @@index([prescriptionId])
  @@index([batchId])
}

model Prescriber {
  id            String         @id @default(cuid())
  name          String
  licenseNumber String
  clinic        String?
  phoneNumber   String?
  email         String?
  specialty     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  storeId       String
  store         Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  prescriptions Prescription[]

  @@unique([storeId, licenseNumber])
  @@index([storeId])
  @@index([licenseNumber])
  @@index([name])
  @@index([clinic])
  @@index([storeId, name])
}

model PrescriptionVersion {
  id                String                    @id @default(cuid())
  prescriptionId    String
  versionNumber     Int
  instructions      String?
  substitutionNotes String?
  attachments       Json?
  changedReason     String?
  createdBy         String
  createdAt         DateTime                  @default(now())
  prescription      Prescription              @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  items             PrescriptionItemVersion[]
  dispenses         Dispense[]

  @@unique([prescriptionId, versionNumber])
  @@index([prescriptionId])
  @@index([createdAt])
}

model PrescriptionItemVersion {
  id                    String              @id @default(cuid())
  prescriptionVersionId String
  drugId                String
  batchId               String?
  quantityPrescribed    Int
  unit                  String?
  conversionFactor      Decimal?            @db.Decimal(10, 2)
  sig                   String?
  daysSupply            Int?
  substitutionAllowed   Boolean             @default(true)
  isControlled          Boolean             @default(false)
  refillsAllowed        Int                 @default(0)
  prescriptionVersion   PrescriptionVersion @relation(fields: [prescriptionVersionId], references: [id], onDelete: Cascade)
  drug                  Drug                @relation(fields: [drugId], references: [id])
  batch                 InventoryBatch?     @relation(fields: [batchId], references: [id])

  @@index([prescriptionVersionId])
  @@index([drugId])
  @@index([batchId])
}

model Refill {
  id             String       @id @default(cuid())
  prescriptionId String
  refillNumber   Int
  authorizedQty  Int
  dispensedQty   Int          @default(0)
  remainingQty   Int
  status         RefillStatus @default(AVAILABLE)
  expiresAt      DateTime?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  dispenses      Dispense[]
  items          RefillItem[]

  @@unique([prescriptionId, refillNumber])
  @@index([prescriptionId])
  @@index([status])
  @@index([expiresAt])
}

model RefillItem {
  id                 String           @id @default(cuid())
  refillId           String
  prescriptionItemId String
  quantityDispensed  Int              @default(0)
  dispensedAt        DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  refill             Refill           @relation(fields: [refillId], references: [id], onDelete: Cascade)
  prescriptionItem   PrescriptionItem @relation(fields: [prescriptionItemId], references: [id])

  @@index([refillId])
  @@index([prescriptionItemId])
}

model Dispense {
  id                    String              @id @default(cuid())
  refillId              String
  prescriptionVersionId String
  status                DispenseStatus      @default(QUEUED)
  queuedAt              DateTime            @default(now())
  verifyingAt           DateTime?
  fillingAt             DateTime?
  checkingAt            DateTime?
  readyAt               DateTime?
  completedAt           DateTime?
  cancelledAt           DateTime?
  queuedBy              String?
  verifiedBy            String?
  filledBy              String?
  checkedBy             String?
  dispensedBy           String?
  quantityDispensed     Int?
  notes                 String?
  cancellationReason    String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  refill                Refill              @relation(fields: [refillId], references: [id], onDelete: Cascade)
  prescriptionVersion   PrescriptionVersion @relation(fields: [prescriptionVersionId], references: [id])
  sale                  Sale?

  @@index([refillId])
  @@index([prescriptionVersionId])
  @@index([status])
  @@index([queuedAt])
  @@index([completedAt])
}

model PrescriptionFile {
  id             String       @id @default(cuid())
  prescriptionId String
  fileUrl        String
  thumbnailUrl   String?
  ocrData        Json?
  uploadedBy     String
  createdAt      DateTime     @default(now())
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
}

model DispenseEvent {
  id             String                 @id @default(cuid())
  prescriptionId String
  workflowStatus DispenseWorkflowStatus @default(INTAKE)
  intakeBy       String?
  intakeAt       DateTime?
  verifyBy       String?
  verifyAt       DateTime?
  fillBy         String?
  fillAt         DateTime?
  checkBy        String?
  checkAt        DateTime?
  releaseBy      String?
  releaseAt      DateTime?
  createdAt      DateTime               @default(now())
  completedAt    DateTime?
  prescription   Prescription           @relation(fields: [prescriptionId], references: [id])
  items          DispenseItem[]

  @@index([prescriptionId])
}

model DispenseItem {
  id                String         @id @default(cuid())
  dispenseEventId   String
  batchId           String
  quantityDispensed Int
  dispenseEvent     DispenseEvent  @relation(fields: [dispenseEventId], references: [id], onDelete: Cascade)
  batch             InventoryBatch @relation(fields: [batchId], references: [id])

  @@index([dispenseEventId])
}

model Shift {
  id         String   @id @default(cuid())
  storeId    String
  name       String
  startTime  String
  endTime    String
  daysOfWeek Int[]
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  users      User[]

  @@index([storeId])
  @@index([storeId, isActive])
}

model AttendanceLog {
  id                    String    @id @default(cuid())
  userId                String
  storeId               String
  checkInTime           DateTime
  checkOutTime          DateTime?
  locationSnapshot      Json?
  faceVerificationScore Float?
  status                String
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  store                 Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([userId, checkInTime])
  @@index([storeId, checkInTime])
  @@index([userId, storeId, checkInTime])
}

model StaffDocument {
  id           String    @id @default(cuid())
  userId       String
  documentType String
  fileUrl      String
  expiryDate   DateTime?
  status       String    @default("ACTIVE")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
}

model PerformanceMetric {
  id                     String   @id @default(cuid())
  userId                 String
  storeId                String
  date                   DateTime
  salesAmount            Decimal  @db.Decimal(10, 2)
  hoursWorked            Float
  prescriptionsProcessed Int      @default(0)
  prescriptionsVerified  Int      @default(0)
  prescriptionsRejected  Int      @default(0)
  createdAt              DateTime @default(now())
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  store                  Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId, date])
  @@index([userId, date])
  @@index([storeId, date])
}

model DispenseWorkflowStep {
  id         String   @id @default(cuid())
  storeId    String
  stepName   String
  isRequired Boolean  @default(true)
  order      Int
  createdAt  DateTime @default(now())

  @@unique([storeId, stepName])
}

model Supplier {
  id                  String                @id @default(cuid())
  name                String
  category            String
  status              String
  gstin               String?
  dlNumber            String?
  pan                 String?
  contactName         String
  phoneNumber         String
  email               String?
  whatsapp            String?
  addressLine1        String
  addressLine2        String?
  city                String
  state               String
  pinCode             String
  paymentTerms        String?
  creditLimit         Decimal?              @db.Decimal(12, 2)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deletedAt           DateTime?
  storeId             String
  store               Store                 @relation(fields: [storeId], references: [id], onDelete: Cascade)
  licenses            SupplierLicense[]
  purchaseOrders      PurchaseOrder[]
  returns             SupplierReturn[]
  goodsReceivedNotes  GoodsReceivedNote[]
  ConsolidatedInvoice ConsolidatedInvoice[]

  @@index([gstin])
  @@index([deletedAt])
  @@index([storeId])
  @@index([storeId, status])
  @@index([storeId, deletedAt])
}

model SupplierLicense {
  id          String   @id @default(cuid())
  supplierId  String
  type        String
  number      String
  validFrom   DateTime
  validTo     DateTime
  documentUrl String?
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
}

model PurchaseOrder {
  id                   String              @id @default(cuid())
  storeId              String
  supplierId           String
  poNumber             String              @unique
  status               POStatus            @default(DRAFT)
  orderDate            DateTime            @default(now())
  expectedDeliveryDate DateTime?
  subtotal             Decimal             @db.Decimal(12, 2)
  taxAmount            Decimal             @db.Decimal(12, 2)
  total                Decimal             @db.Decimal(12, 2)
  currency             String              @default("INR")
  paymentTerms         String?
  createdBy            String
  approvedBy           String?
  approvedAt           DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  deletedAt            DateTime?
  notes                String?
  store                Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier             Supplier            @relation(fields: [supplierId], references: [id])
  items                PurchaseOrderItem[]
  receipts             POReceipt[]
  grns                 GoodsReceivedNote[]
  returns              SupplierReturn[]
  attachments          POAttachment[]

  @@index([storeId, status])
  @@index([supplierId])
  @@index([storeId, deletedAt])
}

model POAttachment {
  id              String        @id @default(cuid())
  purchaseOrderId String
  fileName        String
  fileType        String
  mimeType        String
  originalSize    BigInt
  compressedSize  BigInt
  r2Key           String
  url             String
  uploadedAt      DateTime      @default(now())
  uploadedBy      String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("po_attachments")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  poId            String
  drugId          String
  quantity        Int
  receivedQty     Int           @default(0)
  packSize        Int           @default(1)
  packUnit        String        @default("Strip")
  unitPrice       Decimal       @db.Decimal(10, 2)
  discountPercent Decimal       @default(0) @db.Decimal(5, 2)
  gstPercent      Decimal       @db.Decimal(5, 2)
  lineTotal       Decimal       @db.Decimal(12, 2)
  po              PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  drug            Drug          @relation(fields: [drugId], references: [id])

  @@index([poId])
}

model POReceipt {
  id            String        @id @default(cuid())
  poId          String
  receiptDate   DateTime      @default(now())
  receivedBy    String
  notes         String?
  itemsReceived Json
  createdAt     DateTime      @default(now())
  po            PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@index([poId])
}

model POTemplate {
  id           String           @id @default(cuid())
  storeId      String
  name         String
  description  String?
  supplierId   String?
  paymentTerms String?
  notes        String?
  createdBy    String
  isActive     Boolean          @default(true)
  usageCount   Int              @default(0)
  lastUsedAt   DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  deletedAt    DateTime?
  items        POTemplateItem[]

  @@index([storeId, isActive])
  @@index([storeId, deletedAt])
}

model POTemplateItem {
  id              String     @id @default(cuid())
  templateId      String
  drugId          String
  quantity        Int
  unitPrice       Decimal?   @db.Decimal(10, 2)
  discountPercent Decimal    @default(0) @db.Decimal(5, 2)
  template        POTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model GoodsReceivedNote {
  id                     String                   @id @default(cuid())
  grnNumber              String                   @unique
  poId                   String
  storeId                String
  supplierId             String
  status                 GRNStatus                @default(DRAFT)
  supplierInvoiceNo      String?
  supplierInvoiceDate    DateTime?
  receivedBy             String
  receivedDate           DateTime                 @default(now())
  subtotal               Decimal                  @db.Decimal(12, 2)
  taxAmount              Decimal                  @db.Decimal(12, 2)
  total                  Decimal                  @db.Decimal(12, 2)
  notes                  String?
  completedAt            DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  receivedByUser         User                     @relation(fields: [receivedBy], references: [id])
  supplier               Supplier                 @relation(fields: [supplierId], references: [id])
  po                     PurchaseOrder            @relation(fields: [poId], references: [id], onDelete: Cascade)
  items                  GRNItem[]
  discrepancies          GRNDiscrepancy[]
  attachments            GRNAttachment[]
  ConsolidatedInvoiceGRN ConsolidatedInvoiceGRN[]

  @@index([poId])
  @@index([storeId])
  @@index([status])
}

model GRNAttachment {
  id             String            @id @default(cuid())
  grnId          String
  fileName       String
  fileType       String
  mimeType       String
  originalSize   BigInt
  compressedSize BigInt
  r2Key          String
  url            String
  uploadedAt     DateTime          @default(now())
  uploadedBy     String
  grn            GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)

  @@index([grnId])
  @@map("grn_attachments")
}

model GRNItem {
  id                  String                    @id @default(cuid())
  grnId               String
  poItemId            String
  drugId              String
  orderedQty          Int
  receivedQty         Int
  freeQty             Int                       @default(0)
  rejectedQty         Int                       @default(0)
  batchNumber         String
  expiryDate          DateTime?
  mrp                 Decimal                   @db.Decimal(10, 2)
  unitPrice           Decimal                   @db.Decimal(10, 2)
  discountPercent     Decimal                   @default(0) @db.Decimal(5, 2)
  gstPercent          Decimal                   @db.Decimal(5, 2)
  lineTotal           Decimal                   @db.Decimal(12, 2)
  discountType        String                    @default("BEFORE_GST")
  location            String?
  isSplit             Boolean                   @default(false)
  parentItemId        String?
  manufacturerBarcode String?
  grn                 GoodsReceivedNote         @relation(fields: [grnId], references: [id], onDelete: Cascade)
  drug                Drug                      @relation(fields: [drugId], references: [id])
  parent              GRNItem?                  @relation("GRNItemSplit", fields: [parentItemId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  children            GRNItem[]                 @relation("GRNItemSplit")
  invoiceItems        ConsolidatedInvoiceItem[]

  @@index([grnId])
  @@index([poItemId])
  @@index([parentItemId])
}

model GRNDiscrepancy {
  id                 String                 @id @default(cuid())
  grnId              String
  grnItemId          String?
  reason             DiscrepancyReason
  resolution         DiscrepancyResolution?
  expectedQty        Int?
  actualQty          Int?
  discrepancyQty     Int
  description        String
  debitNoteValue     Decimal?               @db.Decimal(10, 2)
  debitNoteGenerated Boolean                @default(false)
  createdAt          DateTime               @default(now())
  resolvedAt         DateTime?
  grn                GoodsReceivedNote      @relation(fields: [grnId], references: [id], onDelete: Cascade)

  @@index([grnId])
  @@index([reason])
  @@map("grn_discrepancies")
}

model ConsolidatedInvoice {
  id                  String                    @id @default(cuid())
  invoiceNumber       String                    @unique
  storeId             String
  supplierId          String?
  invoiceDate         DateTime                  @default(now())
  periodStart         DateTime?
  periodEnd           DateTime?
  subtotal            Decimal                   @db.Decimal(12, 2)
  taxAmount           Decimal                   @db.Decimal(12, 2)
  total               Decimal                   @db.Decimal(12, 2)
  type                ConsolidatedInvoiceType   @default(SINGLE_SUPPLIER)
  status              ConsolidatedInvoiceStatus @default(DRAFT)
  notes               String?
  createdBy           String
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  adjustments         Decimal                   @default(0) @db.Decimal(12, 2)
  confirmedAt         DateTime?
  confirmedBy         String?
  paidAmount          Decimal                   @default(0) @db.Decimal(12, 2)
  paymentDate         DateTime?
  paymentStatus       PaymentStatus             @default(UNPAID)
  supplierInvoiceDate DateTime?
  supplierInvoiceFile String?
  supplierInvoiceNo   String?
  store               Store                     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier            Supplier?                 @relation(fields: [supplierId], references: [id])
  grns                ConsolidatedInvoiceGRN[]
  items               ConsolidatedInvoiceItem[]
  payments            SupplierInvoicePayment[]
  createdByUser       User                      @relation("ConsolidatedInvoiceCreator", fields: [createdBy], references: [id])
  confirmedByUser     User?                     @relation("ConsolidatedInvoiceConfirmer", fields: [confirmedBy], references: [id])

  @@index([storeId, invoiceDate])
  @@index([supplierId])
  @@index([status])
  @@map("consolidated_invoices")
}

model ConsolidatedInvoiceGRN {
  id                    String              @id @default(cuid())
  consolidatedInvoiceId String
  grnId                 String
  consolidatedInvoice   ConsolidatedInvoice @relation(fields: [consolidatedInvoiceId], references: [id], onDelete: Cascade)
  grn                   GoodsReceivedNote   @relation(fields: [grnId], references: [id])

  @@unique([consolidatedInvoiceId, grnId])
  @@index([grnId])
  @@map("consolidated_invoice_grns")
}

model ConsolidatedInvoiceItem {
  id                    String              @id @default(cuid())
  consolidatedInvoiceId String
  drugId                String
  drugName              String
  batchNumber           String?
  unit                  String
  unitPrice             Decimal             @db.Decimal(10, 2)
  gstPercent            Decimal             @db.Decimal(5, 2)
  discountPercent       Decimal             @default(0) @db.Decimal(5, 2)
  subtotal              Decimal             @db.Decimal(12, 2)
  taxAmount             Decimal             @db.Decimal(12, 2)
  lineTotal             Decimal             @db.Decimal(12, 2)
  billedQty             Int
  disputeNotes          String?
  expiryDate            DateTime?
  freeQty               Int                 @default(0)
  grnItemId             String?
  grnNumber             String?
  isDisputed            Boolean             @default(false)
  isExcluded            Boolean             @default(false)
  poNumber              String?
  receivedDate          DateTime?
  receivedQty           Int
  consolidatedInvoice   ConsolidatedInvoice @relation(fields: [consolidatedInvoiceId], references: [id], onDelete: Cascade)
  grnItem               GRNItem?            @relation(fields: [grnItemId], references: [id])

  @@index([consolidatedInvoiceId])
  @@map("consolidated_invoice_items")
}

model SupplierInvoicePayment {
  id                    String              @id @default(cuid())
  consolidatedInvoiceId String
  amount                Decimal             @db.Decimal(12, 2)
  paymentDate           DateTime
  paymentMethod         PaymentMethod
  referenceNumber       String?
  notes                 String?
  createdAt             DateTime            @default(now())
  createdBy             String
  invoice               ConsolidatedInvoice @relation(fields: [consolidatedInvoiceId], references: [id], onDelete: Cascade)
  creator               User                @relation(fields: [createdBy], references: [id])

  @@index([consolidatedInvoiceId])
  @@index([paymentDate])
  @@map("supplier_invoice_payments")
}

model SupplierReturn {
  id              String               @id @default(cuid())
  returnNumber    String               @unique
  poId            String
  storeId         String
  supplierId      String
  status          ReturnStatus         @default(PENDING)
  reason          String
  notes           String?
  subtotal        Decimal              @db.Decimal(10, 2)
  taxAmount       Decimal              @db.Decimal(10, 2)
  total           Decimal              @db.Decimal(10, 2)
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  completedAt     DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  deletedAt       DateTime?
  po              PurchaseOrder        @relation(fields: [poId], references: [id], onDelete: Cascade)
  store           Store                @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier        Supplier             @relation(fields: [supplierId], references: [id])
  items           SupplierReturnItem[]
  requestedByUser User                 @relation("ReturnRequester", fields: [requestedBy], references: [id])
  approvedByUser  User?                @relation("ReturnApprover", fields: [approvedBy], references: [id])

  @@index([poId])
  @@index([storeId])
  @@index([supplierId])
  @@index([status])
  @@index([deletedAt])
}

model SupplierReturnItem {
  id          String         @id @default(cuid())
  returnId    String
  drugId      String
  batchNumber String
  expiryDate  DateTime
  quantity    Int
  unitPrice   Decimal        @db.Decimal(10, 2)
  lineTotal   Decimal        @db.Decimal(10, 2)
  reason      ReturnReason
  notes       String?
  createdAt   DateTime       @default(now())
  return      SupplierReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  drug        Drug           @relation(fields: [drugId], references: [id])

  @@index([returnId])
  @@index([drugId])
}

model Sale {
  id                   String              @id @default(cuid())
  storeId              String
  invoiceNumber        String              @unique
  invoiceType          InvoiceType         @default(RECEIPT)
  patientId            String?
  subtotal             Decimal             @db.Decimal(10, 2)
  discountAmount       Decimal             @default(0) @db.Decimal(10, 2)
  taxAmount            Decimal             @db.Decimal(10, 2)
  roundOff             Decimal             @default(0) @db.Decimal(5, 2)
  total                Decimal             @db.Decimal(10, 2)
  originalSaleId       String?
  creditReason         String?
  soldBy               String
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  deletedAt            DateTime?
  status               SaleStatus          @default(COMPLETED)
  prescriptionId       String?
  attachments          Json?
  balance              Decimal             @default(0.00) @db.Decimal(10, 2)
  paymentStatus        PaymentStatus       @default(PAID)
  dispenseForPatientId String?
  dispenseId           String?             @unique
  buyerGstin           String?
  placeOfSupply        String?
  cessAmount           Decimal             @default(0) @db.Decimal(10, 2)
  cgstAmount           Decimal             @default(0) @db.Decimal(10, 2)
  gstrCategory         String?
  igstAmount           Decimal             @default(0) @db.Decimal(10, 2)
  isIgst               Boolean             @default(false)
  sgstAmount           Decimal             @default(0) @db.Decimal(10, 2)
  taxableAmount        Decimal             @default(0) @db.Decimal(10, 2)
  store                Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  prescription         Prescription?       @relation(fields: [prescriptionId], references: [id])
  dispense             Dispense?           @relation(fields: [dispenseId], references: [id])
  patient              Patient?            @relation(fields: [patientId], references: [id])
  dispenseForPatient   Patient?            @relation("DispenseFor", fields: [dispenseForPatientId], references: [id])
  originalSale         Sale?               @relation("CreditNotes", fields: [originalSaleId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  creditNotes          Sale[]              @relation("CreditNotes")
  items                SaleItem[]
  paymentSplits        PaymentSplit[]
  refunds              SaleRefund[]
  allocations          InvoiceAllocation[]
  marginLedger         MarginLedger[]

  @@index([storeId, createdAt, status])
  @@index([storeId, patientId, createdAt])
  @@index([createdAt, status])
  @@index([soldBy, createdAt])
  @@index([storeId, createdAt])
  @@index([storeId, patientId])
  @@index([storeId, status])
  @@index([invoiceNumber])
  @@index([storeId, deletedAt])
  @@index([paymentStatus])
  @@index([placeOfSupply])
  @@index([gstrCategory])
}

model SaleItem {
  id                 String         @id @default(cuid())
  saleId             String
  drugId             String
  batchId            String
  quantity           Int
  mrp                Decimal        @db.Decimal(10, 2)
  discount           Decimal        @default(0) @db.Decimal(10, 2)
  gstRate            Decimal        @db.Decimal(5, 2)
  lineTotal          Decimal        @db.Decimal(10, 2)
  cessAmount         Decimal        @default(0) @db.Decimal(10, 2)
  cgstAmount         Decimal        @default(0) @db.Decimal(10, 2)
  hsnCode            String?
  igstAmount         Decimal        @default(0) @db.Decimal(10, 2)
  sgstAmount         Decimal        @default(0) @db.Decimal(10, 2)
  taxSlabId          String?
  taxableAmount      Decimal        @default(0) @db.Decimal(10, 2)
  baseUnitQuantity   Decimal?       @db.Decimal(12, 3)
  isPartialSale      Boolean        @default(false)
  overrideReason     String?
  partialQuantity    Int?
  partialStripId     String?
  scanMethod         String?
  scanned            Boolean        @default(false)
  unit               String?
  originalDrugId     String?
  substitutedAt      DateTime?
  substitutionReason String?
  sale               Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  drug               Drug           @relation(fields: [drugId], references: [id])
  batch              InventoryBatch @relation(fields: [batchId], references: [id])
  marginLedger       MarginLedger[]

  @@index([saleId])
  @@index([hsnCode])
}

model PaymentSplit {
  id               String        @id @default(cuid())
  saleId           String
  paymentMethod    PaymentMethod
  amount           Decimal       @db.Decimal(10, 2)
  cardLast4        String?
  cardBrand        String?
  cardAuthCode     String?
  upiTransactionId String?
  upiVpa           String?
  walletProvider   String?
  walletTxnId      String?
  createdAt        DateTime      @default(now())
  sale             Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model InvoiceAllocation {
  id        String         @id @default(cuid())
  saleId    String
  ledgerId  String
  amount    Decimal        @db.Decimal(10, 2)
  createdAt DateTime       @default(now())
  sale      Sale           @relation(fields: [saleId], references: [id])
  ledger    CustomerLedger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([ledgerId])
}

model SaleDraft {
  id            String   @id @default(cuid())
  storeId       String
  draftNumber   String   @unique
  customerName  String?
  customerPhone String?
  customerId    String?
  items         Json
  subtotal      Decimal  @db.Decimal(10, 2)
  taxAmount     Decimal  @db.Decimal(10, 2)
  total         Decimal  @db.Decimal(10, 2)
  createdBy     String
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  dispenseFor   Json?
  store         Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
  @@index([expiresAt])
  @@index([storeId, expiresAt])
}

model SaleRefund {
  id             String           @id @default(cuid())
  refundNumber   String           @unique
  originalSaleId String
  storeId        String
  refundAmount   Decimal          @db.Decimal(10, 2)
  refundReason   String
  status         RefundStatus     @default(PENDING)
  requestedBy    String
  approvedBy     String?
  approvedAt     DateTime?
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  items          SaleRefundItem[]
  originalSale   Sale             @relation(fields: [originalSaleId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  store          Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
  @@index([originalSaleId])
  @@index([storeId, createdAt])
}

model SaleRefundItem {
  id           String     @id @default(cuid())
  refundId     String
  saleItemId   String
  drugId       String
  batchId      String
  quantity     Int
  refundAmount Decimal    @db.Decimal(10, 2)
  reason       String
  createdAt    DateTime   @default(now())
  refund       SaleRefund @relation(fields: [refundId], references: [id], onDelete: Cascade)

  @@index([refundId])
  @@index([saleItemId])
}

model Expense {
  id            String          @id @default(cuid())
  storeId       String
  vendorId      String?
  vendorName    String
  invoiceNumber String
  invoiceDate   DateTime
  dueDate       DateTime?
  grossAmount   Decimal         @db.Decimal(12, 2)
  gstAmount     Decimal         @db.Decimal(12, 2)
  tdsAmount     Decimal         @default(0) @db.Decimal(12, 2)
  netAmount     Decimal         @db.Decimal(12, 2)
  categoryId    String
  status        ExpenseStatus   @default(DRAFT)
  attachments   Json?
  createdBy     String
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?
  store         Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category      ExpenseCategory @relation(fields: [categoryId], references: [id])

  @@index([storeId, status])
  @@index([storeId, deletedAt])
}

model ExpenseCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  glAccount   String?
  createdAt   DateTime  @default(now())
  expenses    Expense[]
}

model Claim {
  id            String    @id @default(cuid())
  storeId       String
  type          String
  relatedSaleId String?
  relatedPOId   String?
  reason        String
  amount        Decimal   @db.Decimal(10, 2)
  status        String
  createdBy     String
  resolvedBy    String?
  resolvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([storeId, status])
}

model Reconciliation {
  id            String   @id @default(cuid())
  storeId       String
  reconcileDate DateTime
  expectedCash  Decimal  @db.Decimal(10, 2)
  actualCash    Decimal  @db.Decimal(10, 2)
  difference    Decimal  @db.Decimal(10, 2)
  cardAmount    Decimal  @db.Decimal(10, 2)
  upiAmount     Decimal  @db.Decimal(10, 2)
  walletAmount  Decimal  @db.Decimal(10, 2)
  notes         String?
  reconciledBy  String
  createdAt     DateTime @default(now())

  @@index([storeId, reconcileDate])
}

model OCRJob {
  id               String    @id @default(cuid())
  storeId          String
  documentUrl      String
  documentType     String
  status           String
  extractedData    Json?
  confidence       Float?
  vendorCandidates Json?
  processedAt      DateTime?
  createdAt        DateTime  @default(now())

  @@index([storeId, status])
}

model BankAccount {
  id            String            @id @default(cuid())
  storeId       String
  accountNumber String
  bankName      String
  ifscCode      String
  accountType   String
  balance       Decimal           @db.Decimal(12, 2)
  lastSyncedAt  DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  transactions  BankTransaction[]

  @@index([storeId])
}

model BankTransaction {
  id                  String            @id @default(cuid())
  accountId           String
  txnDate             DateTime
  amount              Decimal           @db.Decimal(10, 2)
  direction           String
  description         String
  bankReference       String
  extractedInvoiceIds String[]
  extractedUpiId      String?
  status              String
  matchedSaleId       String?
  matchedExpenseId    String?
  matchConfidence     Float?
  createdAt           DateTime          @default(now())
  account             BankAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  suggestions         MatchSuggestion[]

  @@index([accountId, txnDate])
  @@index([status])
}

model MatchSuggestion {
  id              String          @id @default(cuid())
  bankTxnId       String
  candidateType   String
  candidateId     String
  score           Float
  reason          String
  bankTransaction BankTransaction @relation(fields: [bankTxnId], references: [id], onDelete: Cascade)

  @@index([bankTxnId])
}

model PaymentGateway {
  id            String               @id @default(cuid())
  storeId       String
  provider      String
  status        String
  merchantId    String?
  apiKey        String?
  apiSecret     String?
  webhookSecret String?
  qrCodeUrl     String?
  upiVpa        String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  transactions  GatewayTransaction[]
  settlements   Settlement[]
  webhooks      WebhookLog[]

  @@index([storeId, status])
}

model GatewayTransaction {
  id            String         @id @default(cuid())
  gatewayId     String
  saleId        String?
  providerTxnId String         @unique
  amount        Decimal        @db.Decimal(10, 2)
  currency      String         @default("INR")
  status        String
  paymentMethod String
  upiVpa        String?
  upiTxnId      String?
  cardLast4     String?
  cardNetwork   String?
  createdAt     DateTime       @default(now())
  gateway       PaymentGateway @relation(fields: [gatewayId], references: [id])

  @@index([gatewayId, status])
  @@index([saleId])
}

model Settlement {
  id           String         @id @default(cuid())
  gatewayId    String
  settlementId String         @unique
  amount       Decimal        @db.Decimal(10, 2)
  fee          Decimal        @db.Decimal(10, 2)
  tax          Decimal        @db.Decimal(10, 2)
  netAmount    Decimal        @db.Decimal(10, 2)
  status       String
  utr          String?
  settledAt    DateTime?
  createdAt    DateTime       @default(now())
  gateway      PaymentGateway @relation(fields: [gatewayId], references: [id])

  @@index([gatewayId, status])
}

model WebhookLog {
  id          String         @id @default(cuid())
  gatewayId   String
  event       String
  payload     Json
  status      String
  retryCount  Int            @default(0)
  processedAt DateTime?
  createdAt   DateTime       @default(now())
  gateway     PaymentGateway @relation(fields: [gatewayId], references: [id])

  @@index([gatewayId, createdAt])
}

model GSTReturn {
  id         String    @id @default(cuid())
  storeId    String
  returnType String
  period     String
  status     String
  filedAt    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([storeId, period])
}

model GSTTransaction {
  id              String   @id @default(cuid())
  storeId         String
  transactionType String
  referenceId     String
  gstin           String?
  taxableValue    Decimal  @db.Decimal(12, 2)
  cgst            Decimal  @db.Decimal(10, 2)
  sgst            Decimal  @db.Decimal(10, 2)
  igst            Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now())

  @@index([storeId, transactionType])
}

model IRN {
  id        String   @id @default(cuid())
  saleId    String   @unique
  irn       String   @unique
  ackNo     String
  ackDate   DateTime
  qrCode    String?
  createdAt DateTime @default(now())

  @@index([irn])
}

model ComplianceCheck {
  id        String   @id @default(cuid())
  storeId   String
  checkType String
  status    String
  findings  Json
  checkedAt DateTime @default(now())

  @@index([storeId, checkType])
}

model WhatsAppAccount {
  id                        String             @id @default(cuid())
  storeId                   String             @unique
  wabaId                    String?
  phoneNumberId             String?            @unique
  phoneNumber               String?
  accessToken               String?
  tempToken                 String?
  tokenExpiresAt            DateTime?
  webhookSecret             String?
  status                    WhatsAppStatus     @default(DISCONNECTED)
  businessVerified          Boolean            @default(false)
  lastWebhookReceivedAt     DateTime?
  businessDisplayName       String?
  businessAbout             String?
  businessProfilePictureUrl String?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  store                     Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  conversations             Conversation[]
  templates                 WhatsAppTemplate[]

  @@index([phoneNumberId])
  @@index([storeId, status])
}

model MarginLedger {
  id              String   @id @default(cuid())
  storeId         String
  saleId          String
  saleItemId      String
  batchId         String
  drugId          String
  
  // Financials (Per Unit)
  costPrice       Decimal  @db.Decimal(12, 4) // High precision for partials
  sellingPrice    Decimal  @db.Decimal(12, 4)
  taxAmount       Decimal  @db.Decimal(10, 2)
  
  // Totals
  quantity        Decimal  @db.Decimal(10, 2) // Supports partial strips
  totalCost       Decimal  @db.Decimal(12, 2)
  totalRevenue    Decimal  @db.Decimal(12, 2)
  marginAmount    Decimal  @db.Decimal(12, 2)
  
  // Meta
  marginPercent   Decimal  @db.Decimal(6, 2)
  isProvisional   Boolean  @default(false)
  type            String   @default("SALE") // SALE, RETURN, ADJUSTMENT
  notes           String?
  
  // Timestamps
  finalizedAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  
  // Relations
  store           Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  drug            Drug           @relation(fields: [drugId], references: [id])
  batch           InventoryBatch @relation(fields: [batchId], references: [id])
  sale            Sale           @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleItem        SaleItem       @relation(fields: [saleItemId], references: [id], onDelete: Cascade)

  @@index([storeId, finalizedAt])
  @@index([saleId])
  @@index([drugId])
  @@index([batchId])
  @@index([type])
}

model Conversation {
  id                    String          @id @default(cuid())
  storeId               String
  whatsappAccountId     String
  phoneNumber           String
  displayName           String?
  profilePicUrl         String?
  status                String          @default("open")
  assignedAgentId       String?
  lastMessageAt         DateTime?
  lastMessageBody       String?
  unreadCount           Int             @default(0)
  tags                  String[]        @default([])
  lastCustomerMessageAt DateTime?
  sessionActive         Boolean         @default(false)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  whatsappAccount       WhatsAppAccount @relation(fields: [whatsappAccountId], references: [id], onDelete: Cascade)
  messages              Message[]

  @@unique([storeId, phoneNumber])
  @@index([storeId, status])
  @@index([storeId, lastMessageAt])
  @@index([assignedAgentId])
}

model Message {
  id                String           @id @default(cuid())
  conversationId    String
  storeId           String
  providerMessageId String?          @unique
  wabaPhoneNumberId String?
  direction         MessageDirection
  type              MessageType
  body              String?
  caption           String?
  mediaUrl          String?
  mediaType         String?
  mediaSize         Int?
  mediaFileName     String?
  from              String?
  to                String?
  status            MessageStatus?
  statusReason      String?
  templateName      String?
  templateLanguage  String?
  templateParams    Json?
  payload           Json?
  sentAt            DateTime?
  deliveredAt       DateTime?
  readAt            DateTime?
  createdAt         DateTime         @default(now())
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([storeId, direction, createdAt])
  @@index([providerMessageId])
  @@index([wabaPhoneNumberId])
}

model WhatsAppTemplate {
  id                String           @id @default(cuid())
  storeId           String
  whatsappAccountId String?
  name              String
  language          String           @default("en")
  category          String           @default("MARKETING")
  headerType        String?
  headerText        String?
  body              String
  footer            String?
  variables         String[]         @default([])
  buttons           Json?
  status            String           @default("PENDING")
  rejectedReason    String?
  templateId        String?
  namespace         String?
  usageCount        Int              @default(0)
  lastUsedAt        DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  whatsappAccount   WhatsAppAccount? @relation(fields: [whatsappAccountId], references: [id], onDelete: Cascade)

  @@unique([storeId, name, language])
  @@index([storeId, status])
}

model WhatsAppOutboundQueue {
  id             BigInt    @id @default(autoincrement())
  storeId        String
  conversationId String?
  payload        Json
  attemptCount   Int       @default(0)
  maxAttempts    Int       @default(3)
  runAfter       DateTime  @default(now())
  status         String    @default("pending")
  errorMessage   String?
  sentAt         DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([storeId, status, runAfter])
  @@index([status, runAfter])
}

model WhatsAppFlow {
  id          String    @id @default(cuid())
  storeId     String
  name        String
  trigger     String
  nodes       Json
  active      Boolean   @default(false)
  lastRunAt   DateTime?
  successRate Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([storeId, active])
}

model WhatsAppConsent {
  id        String    @id @default(cuid())
  patientId String
  method    String
  source    String
  scope     String
  ipAddress String?
  expiresAt DateTime?
  revokedAt DateTime?
  grantedAt DateTime  @default(now())

  @@index([patientId, revokedAt])
}

model EmailMessageLog {
  id            String   @id @default(cuid())
  storeId       String
  to            String
  templateId    String?
  providerMsgId String
  sentAt        DateTime @default(now())

  @@index([storeId, sentAt])
}

model SMSMessageLog {
  id            String   @id @default(cuid())
  storeId       String
  to            String
  providerMsgId String
  cost          Decimal? @db.Decimal(6, 4)
  sentAt        DateTime @default(now())

  @@index([storeId, sentAt])
}

model Campaign {
  id             String           @id @default(cuid())
  storeId        String
  name           String
  channel        String
  status         String
  targetAudience Json
  messageContent String
  scheduledAt    DateTime?
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  store          Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  targets        CampaignTarget[]

  @@index([storeId, status])
}

model CampaignTarget {
  id         String    @id @default(cuid())
  campaignId String
  patientId  String
  status     String
  sentAt     DateTime?
  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId, status])
}

model Coupon {
  id         String        @id @default(cuid())
  storeId    String
  code       String        @unique
  type       String
  value      Decimal       @db.Decimal(10, 2)
  usageLimit Int?
  validFrom  DateTime
  validTo    DateTime
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  usages     CouponUsage[]

  @@index([code])
  @@index([validFrom, validTo])
}

model CouponUsage {
  id             String   @id @default(cuid())
  couponId       String
  saleId         String
  discountAmount Decimal  @db.Decimal(10, 2)
  usedAt         DateTime @default(now())
  coupon         Coupon   @relation(fields: [couponId], references: [id])

  @@index([couponId])
}

model LoyaltyProgram {
  id             String   @id @default(cuid())
  storeId        String
  tierName       String
  pointsRequired Int
  benefits       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([storeId])
}

model AuditLog {
  id         String   @id @default(cuid())
  storeId    String
  userId     String?
  action     String
  entityType String
  entityId   String
  changes    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())
  metadata   Json?
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([storeId, userId, createdAt])
  @@index([storeId, entityType, entityId])
  @@index([createdAt])
}

model AccessLog {
  id          String   @id @default(cuid())
  userId      String
  eventType   String
  ipAddress   String
  userAgent   String?
  deviceInfo  String?
  createdAt   DateTime @default(now())
  geolocation Json?
  loginMethod String?
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([loginMethod, createdAt])
}

model Alert {
  id          String         @id @default(cuid())
  storeId     String
  type        String
  severity    AlertSeverity
  title       String
  description String
  source      String
  status      AlertStatus    @default(NEW)
  relatedType String?
  relatedId   String?
  resolvedBy  String?
  resolvedAt  DateTime?
  snoozeUntil DateTime?
  createdAt   DateTime       @default(now())
  actionLabel String?
  actionUrl   String?
  blockAction Boolean        @default(false)
  category    AlertCategory  @default(INVENTORY)
  channels    AlertChannel[] @default([IN_APP])
  expiresAt   DateTime?
  metadata    Json?
  seenAt      DateTime?
  seenBy      String?
  priority    AlertPriority  @default(MEDIUM)
  store       Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, status, priority])
  @@index([storeId, category])
  @@index([storeId, status, severity])
  @@index([snoozeUntil])
  @@index([seenAt])
  @@index([expiresAt])
  @@index([relatedType, relatedId])
}

model AlertPreference {
  id              String         @id @default(cuid())
  userId          String
  storeId         String
  category        AlertCategory
  channels        AlertChannel[] @default([IN_APP])
  enabled         Boolean        @default(true)
  quietHoursStart String?
  quietHoursEnd   String?
  digestMode      Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  store           Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId, category])
  @@index([userId, storeId])
}

model BarcodeRegistry {
  id               String         @id @default(cuid())
  barcode          String         @unique
  batchId          String
  barcodeType      String
  manufacturerCode String?
  unitType         String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  batch            InventoryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  scans            ScanAudit[]

  @@index([barcode])
  @@index([batchId])
  @@index([barcodeType])
}

model ScanAudit {
  id         String           @id @default(cuid())
  barcodeId  String?
  employeeId String
  saleId     String?
  scannedAt  DateTime         @default(now())
  scanType   String
  deviceType String?
  storeId    String
  barcode    BarcodeRegistry? @relation(fields: [barcodeId], references: [id], onDelete: Cascade)

  @@index([employeeId, scannedAt])
  @@index([barcodeId, scannedAt])
  @@index([storeId, scannedAt])
}

model FEFODeviation {
  id                 String   @id @default(cuid())
  saleId             String
  saleItemId         String?
  drugId             String
  recommendedBatchId String
  actualBatchId      String
  deviationDays      Int
  employeeId         String
  reason             String?
  storeId            String
  createdAt          DateTime @default(now())

  @@index([employeeId, createdAt])
  @@index([drugId, createdAt])
  @@index([storeId, createdAt])
}

model EmployeeBehaviorMetric {
  id                 String   @id @default(cuid())
  employeeId         String
  storeId            String
  date               DateTime @db.Date
  scanBypassCount    Int      @default(0)
  voidCount          Int      @default(0)
  overrideCount      Int      @default(0)
  fefoDeviationCount Int      @default(0)
  manualEntryCount   Int      @default(0)
  totalSalesCount    Int      @default(0)
  manualEntryRate    Float    @default(0)
  anomalyScore       Float    @default(0)
  peerRank           Int?
  lastCalculatedAt   DateTime @updatedAt

  @@unique([employeeId, storeId, date])
  @@index([date, anomalyScore])
  @@index([storeId, date])
  @@index([employeeId, date])
}

model OperationOverride {
  id            String   @id @default(cuid())
  employeeId    String
  storeId       String
  overrideType  String
  entityType    String
  entityId      String
  originalValue String?
  newValue      String?
  reason        String
  approvedBy    String?
  timestamp     DateTime @default(now())

  @@index([employeeId, timestamp])
  @@index([overrideType, timestamp])
  @@index([storeId, timestamp])
}

model Location {
  id          String             @id @default(cuid())
  storeId     String
  name        String
  displayName String
  type        String
  parentId    String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  parent      Location?          @relation("LocationHierarchy", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  children    Location[]         @relation("LocationHierarchy")
  mappings    LocationMapping[]
  mismatches  LocationMismatch[] @relation("ExpectedLocation")

  @@unique([storeId, name])
  @@index([storeId, isActive])
  @@index([parentId])
}

model LocationMapping {
  id            String   @id @default(cuid())
  drugId        String
  locationId    String
  storeId       String
  isPrimary     Boolean  @default(false)
  lastRestockAt DateTime @default(now())
  createdAt     DateTime @default(now())
  drug          Drug     @relation(fields: [drugId], references: [id], onDelete: Cascade)
  location      Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([drugId, locationId])
  @@index([locationId])
  @@index([storeId])
}

model LocationMismatch {
  id                  String    @id @default(cuid())
  saleId              String
  drugId              String
  storeId             String
  expectedLocationId  String
  suspectedLocationId String?
  detectedAt          DateTime  @default(now())
  resolvedAt          DateTime?
  resolution          String?
  expectedLocation    Location  @relation("ExpectedLocation", fields: [expectedLocationId], references: [id])

  @@index([drugId, detectedAt])
  @@index([storeId, detectedAt, resolvedAt])
}

model PartialStripInventory {
  id               String         @id @default(cuid())
  batchId          String
  storeId          String
  stripIdentifier  String
  totalTablets     Int
  tabletsRemaining Int
  firstOpenedAt    DateTime       @default(now())
  lastSoldAt       DateTime       @updatedAt
  closedAt         DateTime?
  batch            InventoryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId, tabletsRemaining])
  @@index([storeId, tabletsRemaining])
}

model APIKey {
  id          String       @id @default(cuid())
  storeId     String
  name        String
  keyPrefix   String
  keyHash     String
  permissions String[]
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime     @default(now())
  revokedAt   DateTime?
  requests    APIRequest[]

  @@index([storeId, revokedAt])
}

model APIRequest {
  id           String   @id @default(cuid())
  apiKeyId     String
  endpoint     String
  method       String
  statusCode   Int
  responseTime Int
  ipAddress    String
  userAgent    String?
  createdAt    DateTime @default(now())
  apiKey       APIKey   @relation(fields: [apiKeyId], references: [id])

  @@index([apiKeyId, createdAt])
  @@index([createdAt])
}

model WebhookEndpoint {
  id        String   @id @default(cuid())
  storeId   String
  url       String
  events    String[]
  secret    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, active])
}

model BackupPlan {
  id               String           @id @default(cuid())
  storeId          String
  name             String
  frequency        String
  retentionDays    Int
  includeDocuments Boolean          @default(true)
  active           Boolean          @default(true)
  nextRunAt        DateTime
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  snapshots        BackupSnapshot[]

  @@index([storeId, active])
}

model BackupSnapshot {
  id              String     @id @default(cuid())
  planId          String
  storeId         String
  size            BigInt
  status          String
  storageLocation String
  checksum        String?
  recordCounts    Json?
  createdAt       DateTime   @default(now())
  completedAt     DateTime?
  plan            BackupPlan @relation(fields: [planId], references: [id])

  @@index([storeId, createdAt])
}

model Document {
  id         String   @id @default(cuid())
  storeId    String
  entityType String
  entityId   String
  fileType   String
  filePath   String
  fileSize   Int
  uploadedBy String
  createdAt  DateTime @default(now())

  @@index([storeId, entityType, entityId])
}

model PatientAudit {
  id        String   @id @default(cuid())
  patientId String
  userId    String
  action    String
  changes   Json
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, createdAt])
}

model DrugUnit {
  id         String   @id @default(cuid())
  drugId     String
  baseUnit   String
  parentUnit String?
  childUnit  String
  conversion Decimal  @db.Decimal(10, 3)
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  drug       Drug     @relation(fields: [drugId], references: [id], onDelete: Cascade)

  @@unique([drugId, parentUnit, childUnit])
  @@index([drugId, isDefault])
  @@index([drugId, baseUnit])
}

model Salt {
  id               String         @id @default(cuid())
  name             String         @unique
  category         String?
  therapeuticClass String?
  highRisk         Boolean        @default(false)
  aliases          String[]
  createdById      String?
  createdBy        User?          @relation("SaltCreator", fields: [createdById], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  drugSaltLinks    DrugSaltLink[]

  @@index([name])
  @@index([category])
  @@index([highRisk])
  @@index([createdById])
}

model DrugSaltLink {
  id            String   @id @default(cuid())
  drugId        String
  saltId        String
  strengthValue Decimal  @db.Decimal(10, 3)
  strengthUnit  String
  role          String   @default("PRIMARY")
  order         Int      @default(1)
  createdAt     DateTime @default(now())
  drug          Drug     @relation(fields: [drugId], references: [id], onDelete: Cascade)
  salt          Salt     @relation(fields: [saltId], references: [id], onDelete: Cascade)

  @@unique([drugId, saltId])
  @@index([drugId])
  @@index([saltId])
  @@index([saltId, strengthValue, strengthUnit])
  @@index([drugId, role])
}

model UserAvatar {
  id         String   @id @default(cuid())
  userId     String
  sha        String
  key        String
  version    Int      @default(1)
  isActive   Boolean  @default(true)
  uploadedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([sha])
}

model AvatarObject {
  sha          String   @id
  key          String
  sizeBytes    BigInt
  refCount     Int      @default(0)
  createdAt    DateTime @default(now())
  lastAccessed DateTime @updatedAt

  @@index([refCount])
}

model EmailAccount {
  id                    String          @id @default(cuid())
  storeId               String
  email                 String
  provider              String
  smtpHost              String?
  smtpPort              Int?
  smtpUser              String?
  smtpPasswordEncrypted String?
  useTLS                Boolean         @default(true)
  isVerified            Boolean         @default(false)
  isActive              Boolean         @default(true)
  lastTestedAt          DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  isPrimary             Boolean         @default(false)
  authMethod            String          @default("SMTP")
  gmailAccessToken      String?
  gmailRefreshToken     String?
  gmailTokenExpiry      DateTime?
  oauthConnectedAt      DateTime?
  store                 Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sentEmails            EmailLog[]
  templates             EmailTemplate[]

  @@unique([storeId, email])
  @@index([storeId, isPrimary])
  @@index([email])
}

model EmailTemplate {
  id             String       @id @default(cuid())
  emailAccountId String
  name           String
  subject        String
  bodyHtml       String
  variables      String[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  category       String       @default("general")
  isBuiltIn      Boolean      @default(false)
  tags           String[]     @default([])
  emailAccount   EmailAccount @relation(fields: [emailAccountId], references: [id], onDelete: Cascade)

  @@index([emailAccountId])
  @@index([emailAccountId, category])
}

model EmailLog {
  id             String       @id @default(cuid())
  emailAccountId String
  to             String[]
  cc             String[]     @default([])
  bcc            String[]     @default([])
  subject        String
  bodyHtml       String
  attachments    Json?
  status         EmailStatus
  errorMessage   String?
  sentBy         String
  contextType    String?
  contextId      String?
  createdAt      DateTime     @default(now())
  sentAt         DateTime?
  emailAccount   EmailAccount @relation(fields: [emailAccountId], references: [id], onDelete: Cascade)

  @@index([emailAccountId, createdAt])
  @@index([status])
  @@index([contextType, contextId])
}

model PatientRelation {
  id               String   @id @default(cuid())
  patientId        String
  relatedPatientId String
  relationType     String
  createdAt        DateTime @default(now())
  patient          Patient  @relation("SourcePatient", fields: [patientId], references: [id], onDelete: Cascade)
  relatedPatient   Patient  @relation("RelatedPatient", fields: [relatedPatientId], references: [id], onDelete: Cascade)

  @@unique([patientId, relatedPatientId])
  @@index([patientId])
}

model LoyaltyProfile {
  id                 String          @id @default(cuid())
  patientId          String          @unique
  storeId            String
  status             LoyaltyStatus   @default(NEW)
  statusSince        DateTime        @default(now())
  totalPoints        Int             @default(0)
  purchaseCount      Int             @default(0)
  feedbackCount      Int             @default(0)
  daysSinceFirst     Int             @default(0)
  consistencyScore   Decimal         @default(0) @db.Decimal(5, 2)
  engagementScore    Decimal         @default(0) @db.Decimal(5, 2)
  lastPurchaseAt     DateTime?
  nextMilestoneAt    DateTime?
  milestoneProgress  Decimal         @default(0) @db.Decimal(5, 2)
  recognitionMessage String?
  recognizedAt       DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  patient            Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  events             LoyaltyEvent[]
  rewards            LoyaltyReward[]

  @@index([patientId])
  @@index([storeId, status])
  @@index([storeId, updatedAt])
}

model LoyaltyEvent {
  id             String           @id @default(cuid())
  profileId      String
  storeId        String
  eventType      LoyaltyEventType
  eventSource    String?
  points         Int              @default(0)
  frequencyBonus Int              @default(0)
  timeBonus      Int              @default(0)
  metadata       Json?
  description    String?
  createdAt      DateTime         @default(now())
  profile        LoyaltyProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
  @@index([storeId, eventType, createdAt])
}

model LoyaltyReward {
  id           String              @id @default(cuid())
  profileId    String
  storeId      String
  type         LoyaltyRewardType
  status       LoyaltyRewardStatus @default(LOCKED)
  title        String
  description  String?
  minStatus    LoyaltyStatus?
  minPoints    Int?
  creditAmount Decimal?            @db.Decimal(10, 2)
  unlockedAt   DateTime?
  redeemedAt   DateTime?
  expiresAt    DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  profile      LoyaltyProfile      @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, status])
  @@index([storeId, type])
}

model PlatformEmailConfig {
  id                String    @id @default("platform_email")
  isActive          Boolean   @default(false)
  lastTestedAt      DateTime?
  lastTestResult    Boolean?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  authMethod        String    @default("OAUTH")
  connectedAt       DateTime?
  gmailAccessToken  String?
  gmailEmail        String?
  gmailRefreshToken String?
  gmailTokenExpiry  DateTime?
}

enum UserRole {
  ADMIN
  PHARMACIST
  TECHNICIAN
  CASHIER
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum PrescriptionStatus {
  DRAFT
  IN_PROGRESS
  ON_HOLD
  AWAITING_AUTH
  PARTIAL_FILLED
  COMPLETED
  CANCELLED
  VERIFIED
  ACTIVE
  EXPIRED
}

enum PrescriptionType {
  REGULAR
  ONE_TIME
}

enum RefillStatus {
  AVAILABLE
  PARTIALLY_USED
  FULLY_USED
  EXPIRED
  CANCELLED
}

enum DispenseStatus {
  QUEUED
  VERIFYING
  FILLING
  CHECKING
  READY
  COMPLETED
  CANCELLED
}

enum DispenseWorkflowStatus {
  INTAKE
  VERIFY
  FILL
  CHECK
  RELEASE
  COMPLETED
}

enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
  CANCELLED
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum ReturnReason {
  DAMAGED
  EXPIRED
  WRONG_ITEM
  QUALITY_ISSUE
  OVERSTOCKED
  OTHER
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  WALLET
  CREDIT
}

enum PaymentStatus {
  PAID
  PARTIAL
  UNPAID
  OVERDUE
}

enum InvoiceType {
  RECEIPT
  GST_INVOICE
  CREDIT_NOTE
  ESTIMATE
}

enum SaleStatus {
  DRAFT
  COMPLETED
  REFUNDED
  PARTIALLY_REFUNDED
  CANCELLED
  QUOTATION
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum ExpenseStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PAID
  PARTIAL
  DISPUTED
  CANCELLED
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

enum AlertStatus {
  NEW
  SNOOZED
  RESOLVED
}

enum AlertCategory {
  INVENTORY
  SECURITY
  PATIENT
  BILLING
  SYSTEM
  CLINICAL
}

enum AlertPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AlertChannel {
  IN_APP
  WHATSAPP
  EMAIL
  SMS
}

enum GRNStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DiscrepancyReason {
  SHORTAGE
  OVERAGE
  DAMAGED
  EXPIRED
  WRONG_ITEM
  MISSING
}

enum DiscrepancyResolution {
  BACKORDER
  CANCELLED
  DEBIT_NOTE
  ACCEPTED
}

enum LoyaltyStatus {
  NEW
  REGULAR
  TRUSTED
  INSIDER
  ADVOCATE
}

enum LoyaltyEventType {
  PURCHASE_COMPLETED
  FEEDBACK_SUBMITTED
  PRESCRIPTION_FILLED
  MILESTONE_REACHED
  REWARD_EARNED
  REWARD_REDEEMED
  COMEBACK
}

enum LoyaltyRewardType {
  THANK_YOU_CREDIT
  MILESTONE_PERK
  PRIORITY_SERVICE
  EARLY_ACCESS
  SURPRISE_BONUS
  COMEBACK_WELCOME
}

enum LoyaltyRewardStatus {
  LOCKED
  UNLOCKED
  REDEEMED
  EXPIRED
}

enum LedgerType {
  DEBIT
  CREDIT
}

enum LedgerReferenceType {
  SALE
  PAYMENT
  RETURN
  OPENING_BALANCE
  ADJUSTMENT
}

enum ConsolidatedInvoiceType {
  SINGLE_SUPPLIER
  MULTI_SUPPLIER
  PERIOD
}

enum ConsolidatedInvoiceStatus {
  DRAFT
  FINALIZED
  SENT
  ARCHIVED
  CONFIRMED
  SENT_TO_SUPPLIER
  PARTIALLY_PAID
  PAID
  DISPUTED
  CANCELLED
}

enum WhatsAppStatus {
  DISCONNECTED
  TEMP_STORED
  ACTIVE
  NO_PHONE
  NEEDS_VERIFICATION
  ERROR
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageType {
  text
  image
  document
  audio
  video
  template
  interactive
  location
  contacts
}

enum MessageStatus {
  sent
  delivered
  read
  failed
}

enum EmailStatus {
  SENT
  FAILED
  PENDING
  BOUNCED
}

enum DrugIngestionStatus {

  DRAFT
  SALT_PENDING
  ACTIVE
}

